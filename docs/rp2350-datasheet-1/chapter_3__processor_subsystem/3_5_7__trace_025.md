---
source_pdf: rp2350-datasheet-1.pdf
repository: llm_database
chapter: Chapter 3. Processor subsystem
section: 3.5.7. Trace
pages: 89-90
type: technical_spec
generated_at: 2026-02-28T17:22:56.644477+00:00
---

# 3.5.7. Trace

There are some cases where a bus deadlock can not be avoided, such as a core using the other core’s AHB-AP, via the
self-hosted debug window, to access some other APB peripheral:
1. The access upstream of the APB’s DRW register will not complete until the downstream access completes
2. The downstream access will not complete until it is granted access to the system APB bridge
3. Access to the APB bridge will not be granted until the upstream access, which is occupying the system APB bridge,
completes
4. See point 1.
This situation can arise when running a self-hosted debugger on one core, and debugging code on the other core which
accesses APB addresses. The deadlock is eventually broken when the APB bridge’s 65536-cycle timeout expires,
abandoning the transfer and returning a bus error to the origin of the upstream access. To avoid this, software should
detect when it is about to use an AP to access an APB address (an address starting with 0x4), and perform the access
directly instead of using the Mem-AP.
This type of deadlock does not occur when the debugger accesses the bus with RISC-V System Bus Access, because
the bus transfer upstream of the DM does not block on completion of the downstream access.
3.5.7. Trace
3.5.7.1. Overview
The ATB trace subsystem is based on the Coresight SoC-600M architecture, as shown in Figure 11.
Upsizer 8/16
AT Buffer
AT Buffer
AT Buffer
AT Buffer
Upsizer 8/16
Upsizer 8/16
Upsizer 8/16
Timestamp
Generator
Funnel
AT Buffer
Trace 
FIFO
TPIU
ITM
ETM
ATBI
Trace port
75 MHz
4 bit DDR
Internal Trace 
Capture
DMA 
Controller
ATBE
Cortex-M33
Raspberry Pi
SoC-600M
Figure 11. Trace
Subsystem
The trace subsystem captures trace messages from each of the Cortex-M33 ITM/ETM components, merges them into
a single trace bus, and sends off-chip through the 4-bit DDR trace port for subsequent capture and analysis by a trace
port analyser.
This allows the developer to review a detailed log of software executed on the processors. The advantage over
conventional hardware debug is that it does this without halting the processors or affecting their execution timing, so
you can diagnose software issues that are hard to reproduce under a debugger.
The trace subsystem comprises the following main components:
• Timestamp Generator: Timestamps propagate to both Cortex-M33 processors, and are applied to ETM and ITM
output so that the relative timing of their trace streams can be recovered.
• Cortex-M33 ETM: Embedded Trace Macrocell, for real-time instruction flow messages generated from
observations of the Cortex-M33’s execution.
• Cortex-M33 ITM: Instruction Trace Macrocell, for software-generated messages.
• ATB Funnel: Merges the Cortex-M33 trace sources into a single trace stream using the timestamps from the
Timestamp Generator.
• TPIU: Trace Port Interface Unit, outputs trace data over trace port pins. The source-synchronous trace interface is
4-bits DDR, up to 75 MHz clock, giving a maximum trace data rate of up to 600 Mb/s.
RP2350 Datasheet
3.5. Debug
88


• Trace FIFO: Optionally captures the 32-bit TPIU trace stream on-device, from which point the DMA can transfer to
main system SRAM.
See the Arm CoreSight ETM-M33 Technical Reference Manual for information about the Cortex-M33 ETM. See the SoC-
600M Technical Reference Manual for information about the other trace components in Figure 11
The trace output clock is fixed at one half of clk_sys. At the maximum system frequency of 150 MHz this yields a
75 MHz TPIU output clock. The trace throughput is reduced at lower system clock frequencies, though this is rarely an
issue in practice as the processor instruction throughput (and therefore the demand for trace output bandwidth) scales
accordingly.
3.5.7.2. Trace FIFO
Trace output goes to one of two data sinks:
• The four-bit TPIU interface streams data out of the chip through GPIOs, for capture by an external probe
• The trace FIFO streams data into SRAM via the system DMA
The bandwidth of the DMA is greater than the bandwidth of the TPIU interface. Capturing into an on-chip buffer also
allows trace to operate through a comparatively low-speed SWD probe without restricting trace bandwidth.
The operation is similar to a micro-trace buffer (MTB). However, all of system SRAM is available for trace. You can also
use other DMA endpoints like the PIO and HSTX to implement your own trace data sinks, for example if you would
prefer a wider and lower-frequency bus than the TPIU provides.
You must enable DMA access to the trace FIFO registers by setting the DMA bit in the ACCESSCTRL CORESIGHT_TRACE
register before attempting to DMA from this FIFO. Configure the DMA for DREQ 53 to select the trace FIFO.
3.5.7.3. List of trace FIFO registers
The trace FIFO registers start at a base address of 0x50700000 (defined as CORESIGHT_TRACE_BASE in the SDK).
Table 96. List of
CORESIGHT_TRACE
registers
Offset
Name
Info
0x0
CTRL_STATUS
Control and status register
0x4
TRACE_CAPTURE_FIFO
FIFO for trace data captured from the TPIU
CORESIGHT_TRACE: CTRL_STATUS Register
Offset: 0x0
Description
Control and status register
Table 97.
CTRL_STATUS
Register
Bits
Description
Type
Reset
31:2
Reserved.
-
-
1
TRACE_CAPTURE_FIFO_OVERFLOW: This status flag is set high when trace
data has been dropped due to the FIFO being full at the point trace data was
sampled. Write 1 to acknowledge and clear the bit.
RW
0x0
RP2350 Datasheet
3.5. Debug
89

